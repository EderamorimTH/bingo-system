<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Minhas Cartelas</title>
  <link rel="stylesheet" href="/styles/cartelas.css">
</head>
<body>
  <div class="container">
    <h1>Minhas Cartelas</h1>
    <p>Jogador: <%= playerName %></p>
    <p>PrÃªmio Atual: <span id="currentPrize"><%= game.currentPrize || '--' %></span></p>
    <p>Ãšltimo NÃºmero: <span id="lastNumber"><%= game.lastNumberDisplay || '--' %></span></p>

    <% cartelas.forEach(cartela => { %>
      <div class="cartela">
        <h3>Cartela <%= cartela.cartelaId %></h3>
        <table id="table-<%= cartela.cartelaId %>">
          <thead>
            <tr>
              <th>B</th>
              <th>I</th>
              <th>N</th>
              <th>G</th>
              <th>O</th>
            </tr>
          </thead>
          <tbody>
            <% for (let row = 0; row < 5; row++) { %>
              <tr>
                <% for (let col = 0; col < 5; col++) { %>
                  <td><%= cartela.numbers[col][row] === 0 ? 'â˜…' : cartela.numbers[col][row] %></td>
                <% } %>
              </tr>
            <% } %>
          </tbody>
        </table>

        <!-- MENSAGEM DE VITÃ“RIA -->
        <p id="winnerMessage-<%= cartela.cartelaId %>" class="<%= winners.some(w => w.cartelaId === cartela.cartelaId) ? '' : 'hidden' %>">
          ðŸŽ‰ ParabÃ©ns! Esta cartela venceu!
        </p>
      </div>
    <% }); %>
  </div>

  <script>
    const cartelasData = <%- JSON.stringify(cartelas || []) %>;
    const winners = <%- JSON.stringify(winners || []) %>;

    const ws = new WebSocket('wss://' + window.location.host);
    ws.onmessage = e => {
      try {
        const data = JSON.parse(e.data);
        if (data.type === 'update') {
          updateUI(data.game || {}, data.winners || []);
        }
      } catch (error) {
        console.error('Erro ao processar mensagem WebSocket:', error);
      }
    };

    function updateUI(game, winners) {
      document.getElementById('lastNumber').textContent = game.lastNumberDisplay || '--';
      document.getElementById('currentPrize').textContent = game.currentPrize && game.currentPrize.trim() ? game.currentPrize : '--';

      cartelasData.forEach(cartela => {
        const winnerMsg = document.getElementById(`winnerMessage-${cartela.cartelaId}`);
        if (winnerMsg) {
          // NOVO: some as mensagens se o bingo foi reiniciado
          if (game.drawnNumbers.length === 0) {
            winnerMsg.classList.add('hidden');
          } else if (winners.some(w => w.cartelaId === cartela.cartelaId)) {
            winnerMsg.classList.remove('hidden');
          } else {
            winnerMsg.classList.add('hidden');
          }
        }
      });
    }
  </script>
</body>
</html>
