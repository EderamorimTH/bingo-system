<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cartelas do Jogador</title>
</head>
<body>
  <div>
    <h2>Prêmio Atual</h2>
    <p id="current-prize"><%= game.currentPrize || '--' %></p>
  </div>
  <div>
    <h2>Informações Adicionais</h2>
    <p id="additional-info"><%= game.additionalInfo || '--' %></p>
  </div>

  <% if (cartelas && cartelas.length > 0) { %>
    <% cartelas.forEach(cartela => { %>
      <div class="cartela-container">
        <h3>Cartela <%= cartela.playerName %> (ID: <%= cartela.cartelaId %>)</h3>
        <% if (winners && winners.includes(cartela.cartelaId)) { %>
          <p class="winner">Parabéns! Esta cartela venceu!</p>
        <% } %>
        <table class="cartela-table" data-cartela-id="<%= cartela.cartelaId %>">
          <tr>
            <th>B</th><th>I</th><th>N</th><th>G</th><th>O</th>
          </tr>
          <% for (let row = 0; row < 5; row++) { %>
            <tr>
              <% for (let col = 0; col < 5; col++) { %>
                <td class="<%= cartela.markedNumbers.includes(cartela.numbers[col][row]) ? 'marked' : '' %>">
                  <%= cartela.numbers[col][row] === 0 ? 'Livre' : cartela.numbers[col][row] %>
                </td>
              <% } %>
            </tr>
          <% } %>
        </table>
      </div>
    <% }) %>
  <% } %>

  <script>
    const ws = new WebSocket('wss://' + window.location.host);
    
    ws.onopen = () => {
      console.log('Conectado ao WebSocket');
    };

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      if (data.type === 'update') {
        // Atualizar prêmio e informações
        document.getElementById('current-prize').textContent = data.game.currentPrize || '--';
        document.getElementById('additional-info').textContent = data.game.additionalInfo || '--';

        // Atualizar cartelas
        if (data.cartelas) {
          data.cartelas.forEach(cartela => {
            const table = document.querySelector(`table[data-cartela-id="${cartela.cartelaId}"]`);
            if (table) {
              const cells = table.querySelectorAll('td');
              cells.forEach((cell, index) => {
                const row = Math.floor(index / 5);
                const col = index % 5;
                const number = cartela.numbers[col][row];
                if (number !== 0 && cartela.markedNumbers.includes(number)) {
                  cell.classList.add('marked');
                } else if (number !== 0) {
                  cell.classList.remove('marked');
                }
              });
            }
          });
        }

        // Atualizar status de vencedor
        if (data.winners && data.winners.length > 0) {
          data.winners.forEach(winnerId => {
            const cartelaContainer = document.querySelector(`.cartela-container:has(table[data-cartela-id="${winnerId}"])`);
            if (cartelaContainer && !cartelaContainer.querySelector('.winner')) {
              const p = document.createElement('p');
              p.className = 'winner';
              p.textContent = 'Parabéns! Esta cartela venceu!';
              cartelaContainer.insertBefore(p, cartelaContainer.querySelector('table'));
            }
          });
        }
      }
    };

    ws.onclose = () => {
      console.log('Desconectado do WebSocket');
    };

    ws.onerror = (error) => {
      console.error('Erro no WebSocket:', error);
    };
  </script>
</body>
</html>
